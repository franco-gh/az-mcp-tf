# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Terraform MCP (Model Context Protocol) Server deployment for Azure Container Apps. The project provides a production-ready deployment of HashiCorp's terraform-mcp-server wrapped in a Server-Sent Events (SSE) interface for VS Code GitHub Copilot integration.

## Architecture

### Core Components

1. **MCP SSE Server** (`mcp-sse-server.py`)
   - Python aiohttp server that wraps the terraform-mcp-server stdio interface
   - Implements SSE protocol for VS Code compatibility
   - Handles authentication via Bearer tokens or X-API-Key headers
   - Spawns terraform-mcp-server processes and manages their lifecycle
   - Main endpoints: `/health`, `/mcp/v1/sse`, `/`

2. **Infrastructure** (`terraform-mcp-keyvault.tf`)
   - Deploys complete Azure infrastructure using Terraform
   - Key components: Resource Group, Key Vault (RBAC-enabled), Container Registry, Container Apps Environment, Managed Identity
   - Uses random suffixes for globally unique resource names
   - API key is generated randomly and stored in Key Vault

3. **Container** (`dockerfile`)
   - Based on `hashicorp/terraform-mcp-server:latest`
   - Adds Python 3 and aiohttp/aiohttp-sse dependencies
   - Exposes port 3000 for HTTP traffic

4. **Deployment** (`deploy.ps1`)
   - PowerShell script that orchestrates the entire deployment
   - Checks prerequisites, purges soft-deleted Key Vaults, runs Terraform, builds Docker image via ACR, updates Container App

## Common Commands

### Full Deployment
```powershell
./deploy.ps1
```
This is the primary deployment command. It handles all steps automatically.

### Regenerate API Token
```powershell
./regenerate-token.ps1
```
Generates a new API token for an existing deployment without redeploying infrastructure. This is useful for:
- Rotating tokens for security purposes
- Granting access to new users without sharing existing tokens
- Revoking compromised tokens

The script will:
1. Generate a new random API key
2. Update the Key Vault secret
3. Update the Container App secret
4. Restart the Container App
5. Update the local `.vscode/mcp.json` configuration

**Note**: All existing tokens will be invalidated after regeneration.

### Terraform Operations
```bash
# Initialize Terraform
terraform init

# Plan changes
terraform plan

# Apply infrastructure changes
terraform apply

# Destroy all resources
terraform destroy -auto-approve

# View outputs (including sensitive API key)
terraform output
terraform output -raw api_key
```

### Azure CLI Operations
```bash
# Build and push Docker image manually
az acr build --registry <ACR_NAME> --image "terraform-mcp-server:latest" --file Dockerfile .

# Update Container App with new image
az containerapp update --name terraform-mcp-server --resource-group terraform-mcp-rg --image "<ACR_LOGIN_SERVER>/terraform-mcp-server:latest"

# View Container App logs
az containerapp logs show --name terraform-mcp-server --resource-group terraform-mcp-rg --follow

# Purge soft-deleted Key Vaults
az keyvault list-deleted
az keyvault purge --name <vault-name>
```

### Testing the Server
```bash
# Health check
curl https://<container-app-url>/health

# Test SSE endpoint (requires API key)
curl -H "Authorization: Bearer <api-key>" https://<container-app-url>/mcp/v1/sse

# Get server info
curl https://<container-app-url>/
```

### Local Development
```bash
# Run Python server locally
PORT=3000 API_KEY=test python3 mcp-sse-server.py

# Test locally (requires terraform-mcp-server installed)
curl -X POST http://localhost:3000/mcp/v1/sse -H "Authorization: Bearer test"
```

## Key Design Decisions

### Security Model
- **Key Vault RBAC Authorization**: Uses Azure RBAC instead of access policies for more granular control
- **Managed Identity**: Container App uses User-Assigned Managed Identity to access Key Vault secrets
- **Soft Delete Protection**: Disabled for easier testing; should be enabled in production
- **API Key Authentication**: Required for all MCP requests; stored in Key Vault and injected as environment variable

### SSE Protocol Wrapper
The terraform-mcp-server uses stdio for communication, but VS Code MCP requires SSE. The Python wrapper:
- Creates subprocess for each SSE connection
- Forwards stdin/stdout between HTTP and terraform-mcp-server process
- Manages process lifecycle and cleanup
- Provides proper error handling and logging

### Container App Configuration
- **Scaling**: Min 1, Max 3 replicas
- **Resources**: 1.0 CPU, 2Gi memory per container
- **Ingress**: External HTTPS with target port 3000
- **Initial Image**: Deploys with public hello-world image, then updated by deploy.ps1 with actual ACR image

## Configuration Files

### .vscode/mcp.json
Generated by `deploy.ps1`. Contains the SSE endpoint URL and API key for VS Code GitHub Copilot integration.

Format:
```json
{
  "servers": {
    "terraform": {
      "url": "https://<container-app-fqdn>/mcp/v1/sse",
      "headers": {
        "Authorization": "Bearer <api-key>"
      },
      "type": "sse"
    }
  }
}
```

## Environment Variables

### mcp-sse-server.py
- `PORT`: HTTP server port (default: 3000)
- `API_KEY`: Required for authentication (injected from Key Vault secret)

### Container App
- Managed via Terraform in `azurerm_container_app.mcp_app.template.container.env`
- API_KEY is injected from container app secret which comes from Key Vault

## Troubleshooting

### Key Vault Already Exists Error
Azure Key Vaults have soft-delete enabled. If you get naming conflicts:
```bash
az keyvault list-deleted
az keyvault purge --name mcp-kv-<suffix>
```
Or run `deploy.ps1` which handles this automatically.

### Container App Not Starting
Check logs:
```bash
az containerapp logs show --name terraform-mcp-server --resource-group terraform-mcp-rg --follow
```

### Permission Errors
The deployment requires:
- Azure subscription contributor access
- Ability to create service principals and role assignments
- Current user must have permissions to assign RBAC roles

## File Naming Convention
- The Python server file must be named `mcp-sse-server.py` (referenced in Dockerfile COPY command)
- Deployment script expects exact filenames: `terraform-mcp-keyvault.tf`, `dockerfile`, `deploy.ps1`
